USE [db_views]
GO
/****** Object:  StoredProcedure [dbo].[BI_INFORMATION_FACTORY]    Script Date: 02/07/2024 16:29:27 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[BI_INFORMATION_FACTORY]
@Colecao varchar(100) = NULL,
@Produto varchar(100) = NULL,
@Cor     varchar(100) = NULL

AS 

BEGIN


SELECT BVR.*, TAB1.*
FROM(
SELECT        A.PRODUTO, A.COR_PRODUTO, PC.DESC_COR_PRODUTO,  P.COLECAO, P.GRUPO_PRODUTO, P.LINHA, P.PERIODO_PCP, P.SUBGRUPO_PRODUTO, 
                         SUM(A.QTDE) AS QTDE_VENDA, SUM(A.VAL_VENDA_BRUTA) AS VAL_VENDA_BRUTA, SUM(A.VAL_VENDA) AS VAL_VENDA, SUM(A.VAL_CUSTO) AS VAL_CUSTO, SUM(A.QTDE * VO.PRECO1) 
                         AS VAL_ORIGINAL


FROM            dbo.DW_VENDAS AS A WITH (NOLOCK) 

                         LEFT OUTER JOIN dbo.PRODUTOS_PRECOS AS VO ON VO.PRODUTO = A.PRODUTO COLLATE Latin1_General_CI_AS AND VO.CODIGO_TAB_PRECO = 'V1' 
						
                         LEFT OUTER JOIN dbo.PRODUTOS AS P ON A.PRODUTO = RTRIM(P.PRODUTO) COLLATE LATIN1_GENERAL_CI_AS

                         LEFT OUTER JOIN dbo.PRODUTOS_PRECOS AS Vv ON Vv.PRODUTO = A.PRODUTO COLLATE Latin1_General_CI_AS AND Vv.CODIGO_TAB_PRECO = 'V2'

                         LEFT OUTER JOIN dbo.PRODUTO_CORES AS PC ON A.PRODUTO = RTRIM(PC.PRODUTO) COLLATE LATIN1_GENERAL_CI_AS AND A.COR_PRODUTO = RTRIM(PC.COR) COLLATE LATIN1_GENERAL_CI_AS

WHERE     
        A.CANAL IN ('VAREJO', 'ECOMMERCE')
        AND (P.COLECAO like CASE WHEN @Colecao IS NOT NULL THEN @Colecao ELSE P.COLECAO END)
        AND (P.PRODUTO like CASE WHEN @Produto IS NOT NULL THEN @Produto ELSE P.PRODUTO END)
        AND (A.COR_PRODUTO like CASE WHEN @Cor IS NOT NULL THEN @Cor ELSE A.COR_PRODUTO END)

GROUP BY A.PRODUTO, A.COR_PRODUTO, PC.DESC_COR_PRODUTO,  P.COLECAO, P.GRUPO_PRODUTO, P.LINHA, P.PERIODO_PCP, P.SUBGRUPO_PRODUTO


) AS BVR

     LEFT JOIN               
	 
	  (SELECT        PRODUTO, COR_PRODUTO, SUM(ESTOQUE) AS TOTAL_ESTOQUE
       FROM            dbo.estoque_produtos AS EP
       WHERE        (1 = 1) 
	   AND (ESTOQUE > '0')
	   AND (FILIAL NOT IN ('MATRIZ IB', 'ESTOQUE EXPED.ATAC.SACADA', 'ESTOQUE EXP.ATACADO OHBOY', 'EST EXP. ATAC. SACADA', 'EST EXP. ATAC. OHBOY NOVO', 
       'EST DEVOLUCAO ATAC SACADA', 'EST DEVOLUCAO ATAC OH BOY', 'ATACADO IB', 'ATACADO ACTUM NOVO', 'ATACADO ACTUM', 'ACTUM ATACADO', 'MATRIZ AT-131', 'INDUSTRIA ACTUM', 'INDUSTRIA IB'))


       GROUP BY PRODUTO, COR_PRODUTO)
	   AS TAB1 ON BVR.PRODUTO = TAB1.PRODUTO COLLATE LATIN1_GENERAL_CI_AS AND BVR.COR_PRODUTO = TAB1.COR_PRODUTO COLLATE LATIN1_GENERAL_CI_AS;



END;

