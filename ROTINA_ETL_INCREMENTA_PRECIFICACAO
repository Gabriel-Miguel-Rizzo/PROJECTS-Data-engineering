USE [db_views]
GO
/****** Object:  StoredProcedure [dbo].[BI_INCREMENTA_PRECIFICACAO]    Script Date: 02/07/2024 16:31:04 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[BI_INCREMENTA_PRECIFICACAO]  AS 


BEGIN

	--TRUNCATE TABLE DW_PRODUTOS_PRECIFICACAO_CARGA;
	DELETE FROM DW_PRODUTOS_PRECIFICACAO_CARGA;
    INSERT INTO DW_PRODUTOS_PRECIFICACAO_CARGA
    SELECT *
    FROM OPENROWSET(
        'Microsoft.ACE.OLEDB.12.0', 
        'Excel 12.0;Database=G:\PRECIFICACAO\precificacao_ohboy_ver25.xlsx;HDR=YES', 
        'SELECT PRODUTO, CUSTO_REAL, CANAL, PV_ORIGINAL, MKUP_ANTES, PV_VAREJO, MKUP_VAREJO, PV_ATACADO, MKUP_ATACADO, OBS, REUNIAO
         FROM [Precificacao_att$]');
END;


BEGIN

MERGE INTO DW_PRODUTOS_PRECIFICACAO AS DPP
USING(

SELECT cast(GETDATE() as DATE) "DATA_REGISTRO",DWPP.PRODUTO, P.COLECAO, DWPP.CUSTO_REAL, DWPP.CANAL, DWPP.PV_ORIGINAL, ROUND(DWPP.MKUP_ANTES,2) MKUP_ANTES, DWPP.PV_VAREJO, ROUND(DWPP.MKUP_VAREJO,2) MKUP_VAREJO, DWPP.PV_ATACADO, ROUND(DWPP.MKUP_ATACADO,2) MKUP_ATACADO,
DWPP.OBS, LEFT(CAST(GETDATE() AS DATE),8) + '01' "REUNIAO"


      ----DWPP.*, P.
FROM DW_PRODUTOS_PRECIFICACAO_CARGA DWPP


INNER JOIN PRODUTOS P
ON RTRIM(P.PRODUTO) = RTRIM(DWPP.PRODUTO) COLLATE Latin1_General_CI_AS


) AS DPPC
 
ON DPP.PRODUTO + DPP.COLECAO = RTRIM(DPPC.PRODUTO) COLLATE Latin1_General_CI_AS + RTRIM(DPPC.COLECAO)  COLLATE Latin1_General_CI_AS

WHEN MATCHED THEN
    -- Operações quando há correspondência
    UPDATE SET DPP.DATA_REGISTRO = DPPC.DATA_REGISTRO ,
	           DPP.PRODUTO       = DPPC.PRODUTO,
			   DPP.COLECAO       = DPPC.COLECAO,
			   DPP.CUSTO_REAL    = DPPC.CUSTO_REAL,
			   DPP.CANAL         = DPPC.CANAL,
			   DPP.PV_ORIGINAL   = DPPC.PV_ORIGINAL,
			   DPP.MKP_ANTES    = DPPC.MKUP_ANTES,
			   DPP.PV_VAREJO     = DPPC.PV_VAREJO,
			   DPP.MKP_VAREJO   = DPPC.MKUP_VAREJO,
			   DPP.PV_ATACADO    = DPPC.PV_ATACADO,
			   DPP.MKP_ATACADO  = DPPC.MKUP_ATACADO,
			   DPP.OBSERVACAO           = DPPC.OBS,
			   DPP.REUNIAO       = DPPC.REUNIAO



WHEN NOT MATCHED THEN
    -- Operações quando não há correspondência
    INSERT (DATA_REGISTRO, PRODUTO, COLECAO, CUSTO_REAL, CANAL, PV_ORIGINAL, MKP_ANTES, PV_VAREJO, MKP_VAREJO, PV_ATACADO, MKP_ATACADO, OBSERVACAO, REUNIAO)
    VALUES(
	DPPC.DATA_REGISTRO,
	DPPC.PRODUTO,
	DPPC.COLECAO,
	DPPC.CUSTO_REAL,
	DPPC.CANAL, 
	DPPC.PV_ORIGINAL,
	DPPC.MKUP_ANTES,
	DPPC.PV_VAREJO,
	DPPC.MKUP_VAREJO,
	DPPC.PV_ATACADO,
	DPPC.MKUP_ATACADO,
	DPPC.OBS,
	DPPC.REUNIAO );

END;
