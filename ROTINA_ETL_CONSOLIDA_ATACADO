USE [db_views]
GO
/****** Object:  StoredProcedure [dbo].[BI_ATUALIZA_VENDAS_PROJECAO_ATACADO]    Script Date: 02/07/2024 16:32:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[BI_ATUALIZA_VENDAS_PROJECAO_ATACADO]  AS 

BEGIN

BEGIN

    TRUNCATE TABLE DW_VENDAS_PROJECAO_ATACADO_CARGA;
    INSERT INTO DW_VENDAS_PROJECAO_ATACADO_CARGA
    SELECT *
    FROM OPENROWSET(
        'Microsoft.ACE.OLEDB.12.0', 
        'Excel 12.0;Database=G:\Consolidacao_Atacado\Wise-OH-BOY-Produtos.xlsx;HDR=YES', 
        'SELECT PRODUTO, COR, QTDE
         FROM [produto$]');
END;

BEGIN

    INSERT INTO DW_VENDAS_PROJECAO_ATACADO_CARGA
    SELECT *
    FROM OPENROWSET(
        'Microsoft.ACE.OLEDB.12.0', 
        'Excel 12.0;Database=G:\Consolidacao_Atacado\Wise-SACADA-Produtos.xlsx;HDR=YES', 
        'SELECT PRODUTO, COR, QTDE
         FROM [produto$]');
END;


BEGIN

--INSERT INTO DW
--FROM CARGA
--JOIN PRODUTOS


MERGE INTO DW_VENDAS_PROJECAO_ATACADO AS	VPA
USING(

SELECT P.GRIFFE, P.COLECAO, VPAC.PRODUTO, VPAC.COR_PRODUTO, VPAC.VENDA_QTDE, NULL PROJECAO_QTDE, CAST(GETDATE() AS DATE) DATA_REGISTRO



FROM DW_VENDAS_PROJECAO_ATACADO_CARGA VPAC


INNER JOIN PRODUTOS P
ON RTRIM(P.PRODUTO) = RTRIM(VPAC.PRODUTO) COLLATE Latin1_General_CI_AS


) AS DPPC
 

ON RTRIM(VPA.PRODUTO) + RTRIM(VPA.COR_PRODUTO) + RTRIM(VPA.COLECAO)  = RTRIM(DPPC.PRODUTO) COLLATE Latin1_General_CI_AS  +  RTRIM(DPPC.COR_PRODUTO) COLLATE Latin1_General_CI_AS + RTRIM(DPPC.COLECAO)  COLLATE Latin1_General_CI_AS


WHEN MATCHED THEN
    -- Operações quando há correspondência
    UPDATE SET  VPA.GRIFFE         = DPPC.GRIFFE,                                  ---DPP.DATA_REGISTRO = DPPC.DATA_REGISTRO ,
	            VPA.COLECAO        = DPPC.COLECAO,
				VPA.PRODUTO        = DPPC.PRODUTO,
				VPA.COR_PRODUTO    = DPPC.COR_PRODUTO,
				VPA.VENDA_QTDE     = DPPC.VENDA_QTDE,
				VPA.PROJECAO_QTDE  = DPPC.PROJECAO_QTDE,
				VPA.DATA_REGISTRO  = DPPC.DATA_REGISTRO



WHEN NOT MATCHED THEN
    -- Operações quando não há correspondência
    INSERT (GRIFFE, COLECAO, PRODUTO, COR_PRODUTO, VENDA_QTDE, PROJECAO_QTDE, DATA_REGISTRO)
    VALUES(
	DPPC.GRIFFE,
	DPPC.COLECAO,
	DPPC.PRODUTO,
	DPPC.COR_PRODUTO,
	DPPC.VENDA_QTDE,
	DPPC.PROJECAO_QTDE,
	DPPC.DATA_REGISTRO);



END;

END;
