USE [db_views]
GO
/****** Object:  StoredProcedure [dbo].[BI_ROTINA_ETL_DISTRIBUICAO_CONSOLIDADO]    Script Date: 02/07/2024 15:16:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[BI_ROTINA_ETL_DISTRIBUICAO_CONSOLIDADO]

AS
BEGIN

TRUNCATE TABLE DISTRIBUICAO_CONSOLIDADO2;
TRUNCATE TABLE CARGA_DISTRIBUICAO_CONSOLIDADO_V2; 

BULK INSERT CARGA_DISTRIBUICAO_CONSOLIDADO_V2
             FROM 'G:\Distribuicao_consolidado\Distribuição - Consolidado.csv' WITH 
             ( FIELDTERMINATOR = ',',ROWTERMINATOR = '\n'); 

INSERT INTO DISTRIBUICAO_CONSOLIDADO2 (PROD_COR, PRODUTO, COR, GRIFFE, COLECAO, PERIODO_PCP, NOVO_PERIODO, DATA_AJUSTE, PRIM_PROG, PRIM_VENDA, LINK_FOTO, X)


SELECT
 CAST(CDC.PROD_COR AS varchar(12) ) as PROD_COR ,CAST('0' + CDC.PRODUTO AS varchar(8)) as PRODUTO ,CAST(RIGHT(CDC.PROD_COR,4) AS varchar(4)) as COR,
 CAST(CDC.GRIFFE as varchar(10)) as GRIFFE, cast(CDC.COLECAO as varchar(10)) as COLECAO, cast(CDC.PERIODO_PCP as varchar(50)) as PERIODO_PCP,
  cast(CDC.[NOVO PERIODO] as varchar(50)) as "NOVO PERIODO", cast(CDC.[DATA AJUSTE] as varchar(50)) as "DATA AJUSTE",
   cast(CDC.[PRIM PROG] as varchar(50)) as "PRIM PROG", cast(CDC.[PRIM VENDA] as varchar(50)) as "PRIM VENDA",  
   cast(CDC.[link_foto] as varchar(200)),
   cast(CDC.x as varchar(5)) as "x"

FROM CARGA_DISTRIBUICAO_CONSOLIDADO_V2 CDC


DELETE FROM DISTRIBUICAO_CONSOLIDADO2 
WHERE PROD_COR = (SELECT TOP (1) PROD_COR 
                       FROM DISTRIBUICAO_CONSOLIDADO2 
                       ORDER BY 1 DESC);



END;
